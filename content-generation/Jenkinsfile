pipeline {
    agent any

    environment {
        DEEPSEEK_API_KEY = credentials('deepsekkapi')
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git',
                    credentialsId: 'github-credentials'
            }
        }

        stage('Setup Python Environment') {
            steps {
                dir('content-generation') {
                    sh '''
                    echo "ğŸ Setting up Python environment..."
                    python3 --version
                    pip3 --version
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install requests
                    echo "âœ… Python packages installed:"
                    pip list | grep requests
                    '''
                }
            }
        }

        stage('Validate Environment') {
            steps {
                dir('content-generation') {
                    sh '''
                    echo "ğŸ” Environment Validation..."
                    . venv/bin/activate
                    echo "ğŸ“ Current directory: $(pwd)"
                    echo "ğŸ“ Files in directory:"
                    ls -la
                    echo "ğŸ”‘ Checking API key availability..."
                    if [ -n "$DEEPSEEK_API_KEY" ]; then
                        echo "âœ… DEEPSEEK_API_KEY is available (length: ${#DEEPSEEK_API_KEY})"
                    else
                        echo "âŒ DEEPSEEK_API_KEY is empty!"
                        exit 1
                    fi
                    echo "ğŸ“„ Checking content.json..."
                    if [ -f "content.json" ]; then
                        echo "âœ… content.json exists"
                        python3 -c "import json; data=json.load(open('content.json')); print('ğŸ“‹ Base content length:', len(data.get('base_content', ''))); print('ğŸ¯ Keywords:', len(data.get('keywords', [])))"
                    else
                        echo "âŒ content.json missing!"
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('Generate Content') {
            steps {
                dir('content-generation') {
                    sh '''
                    echo "ğŸš€ Starting Content Generation..."
                    . venv/bin/activate
                    
                    # Create debug script with detailed logging
                    cat > debug_generator.py << 'EOF'
import json
import os
import requests
import random
import time
import re
import sys

print("ğŸš€ Starting SEO content generator (Debug Version)...")
print(f"ğŸ“ Current directory: {os.getcwd()}")
print(f"ğŸ”‘ API Key available: {'Yes' if os.environ.get('DEEPSEEK_API_KEY') else 'No'}")

# Load content.json
try:
    with open("content.json", "r") as f:
        config = json.load(f)
    print("âœ… content.json loaded successfully")
except Exception as e:
    print(f"âŒ ERROR reading content.json: {e}")
    sys.exit(1)

base_content = config.get("base_content")
domain = config.get("target_domain")
keywords = config.get("keywords", [])
tone = config.get("tone", "professional and educational")

print(f"ğŸ“Š Config Summary:")
print(f"  - Domain: {domain}")
print(f"  - Keywords count: {len(keywords)}")
print(f"  - Base content length: {len(base_content) if base_content else 0}")

if not base_content or not domain:
    print("âŒ ERROR: base_content or domain missing in content.json")
    sys.exit(1)

# DeepSeek API Configuration
DEEPSEEK_API_KEY = os.environ.get("DEEPSEEK_API_KEY")
if not DEEPSEEK_API_KEY:
    print("âŒ ERROR: DEEPSEEK_API_KEY not found!")
    sys.exit(1)

print(f"ğŸ”‘ API Key length: {len(DEEPSEEK_API_KEY)}")

# Extract links
links = re.findall(r"<a href='https://[^']+'[^>]*>[^<]+</a>", base_content)
print(f"ğŸ”— Found {len(links)} links in base content")

if len(links) == 0:
    print("âŒ ERROR: No links found inside base_content!")
    sys.exit(1)

# DeepSeek Content Generator
def generate_single_content(keyword):
    print(f"  ğŸ¤– Generating for: {keyword}")
    
    prompt = f"""
You are an SEO expert and professional human content writer.

Write a short promotional SEO paragraph (35-45 words) based on the topic: **{keyword}**.

STYLE + RULES:
- Natural human tone, no robotic or AI pattern.
- Tone must match Hesiexamtaker services (exam help, guided preparation, confidentiality, expert support).
- Domain name **{domain}** ko exact repeat nahi karna, but concept of "HESI exam help, expert assistance, nursing test support" ko naturally use karna.

MANDATORY:
- Include these links exactly once each inside the content:
{chr(10).join(links)}

OUTPUT:
Only the final content. No explanation. No formatting.
"""

    try:
        headers = {
            "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "model": "deepseek-chat",
            "messages": [
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.7,
            "max_tokens": 500
        }
        
        print(f"  ğŸ“¡ Calling DeepSeek API...")
        response = requests.post(
            "https://api.deepseek.com/v1/chat/completions",
            headers=headers,
            json=payload,
            timeout=60
        )
        
        print(f"  ğŸ“Š API Response Status: {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            if "choices" in result and len(result["choices"]) > 0:
                content = result["choices"][0]["message"]["content"].strip()
                print(f"  âœ… Generated content length: {len(content)}")
                return content
            else:
                print(f"  âŒ No choices in response: {result}")
                return f"Error: No content generated for {keyword}"
        else:
            print(f"  âŒ API Error {response.status_code}: {response.text}")
            return f"API Error for {keyword}"
            
    except Exception as e:
        print(f"  âŒ API Call Failed: {str(e)}")
        return f"Generation failed for {keyword}"

# Main Loop
TOTAL = 10  # Reduced for testing
generated_data = []

print(f"ğŸ¯ Generating {TOTAL} SEO contents...")

for i in range(TOTAL):
    try:
        keyword = random.choice(keywords)
        print(f"ğŸ“ {i+1}/{TOTAL} Processing...")

        content = generate_single_content(keyword)

        # Ensure all required links are included
        links_included = 0
        for link in links:
            if link in content:
                links_included += 1
            else:
                content += f" {link}"

        generated_data.append({
            "id": i + 1,
            "keyword": keyword,
            "content": content,
            "word_count": len(content.split()),
            "links_included": links_included
        })

        print(f"âœ… Completed item {i+1}/{TOTAL}")
        time.sleep(2)  # Rate limiting

    except Exception as e:
        print(f"âŒ Error in item {i+1}: {str(e)}")
        continue

# Save Output
print("ğŸ’¾ Saving to output.json...")
try:
    with open("output.json", "w", encoding="utf-8") as f:
        json.dump(generated_data, f, indent=2, ensure_ascii=False)

    print(f"ğŸ‰ SUCCESS! {len(generated_data)} contents saved in output.json")
    print(f"ğŸ“Š Final stats:")
    print(f"  - Total items: {len(generated_data)}")
    print(f"  - Total words: {sum(item['word_count'] for item in generated_data)}")
    print(f"  - Average links: {sum(item['links_included'] for item in generated_data) / len(generated_data):.1f}")

except Exception as e:
    print(f"âŒ Error saving file: {e}")
    sys.exit(1)
EOF

                    # Run the debug script
                    python3 debug_generator.py
                    '''
                }
            }
        }

        stage('Verify Output') {
            steps {
                dir('content-generation') {
                    sh '''
                    echo "ğŸ” Verifying Output..."
                    . venv/bin/activate
                    
                    python3 - << 'EOF'
import json, os, sys

print("ğŸ“„ Output Verification Started...")
file = "output.json"

if not os.path.exists(file):
    print("âŒ ERROR: output.json file not found!")
    sys.exit(1)

try:
    with open(file, "r", encoding="utf-8") as f:
        data = json.load(f)
    
    print(f"âœ… JSON Verification Successful!")
    print(f"ğŸ“Š Output Details:")
    print(f"  - Total items: {len(data)}")
    print(f"  - First item keys: {list(data[0].keys()) if data else 'No data'}")
    
    if data:
        sample = data[0]
        print(f"  - Sample content length: {len(sample.get('content', ''))}")
        print(f"  - Sample word count: {sample.get('word_count', 0)}")
        print(f"  - Sample links included: {sample.get('links_included', 0)}")
    
    # Validate structure
    required_keys = ['id', 'keyword', 'content', 'word_count']
    for item in data:
        for key in required_keys:
            if key not in item:
                print(f"âŒ Missing key '{key}' in item {item.get('id', 'unknown')}")
                sys.exit(1)
    
    print("ğŸ‰ All verifications passed!")
    
except Exception as e:
    print(f"âŒ JSON Verification Failed: {e}")
    sys.exit(1)
EOF
                    '''
                }
            }
        }

        stage('Push to GitHub') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'github-credentials',
                    usernameVariable: 'GIT_USERNAME',
                    passwordVariable: 'GIT_PASSWORD'
                )]) {
                    dir('content-generation') {
                        sh '''
                        echo "ğŸš€ Preparing to push changes..."
                        . venv/bin/activate

                        git config --global user.email "ayzazkhan82@gmail.com"
                        git config --global user.name "Ayzazkhan"

                        echo "ğŸ“ Current git status:"
                        git status

                        echo "ğŸ”„ Pulling latest changes..."
                        git pull origin main --rebase

                        echo "ğŸ“¦ Adding output.json..."
                        git add output.json

                        echo "ğŸ’¾ Committing changes..."
                        git commit -m "Auto-generated content (Jenkins Build ${BUILD_NUMBER})" || echo "âš  No changes to commit"

                        echo "ğŸš€ Pushing to GitHub..."
                        git remote set-url origin https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git
                        git push origin main
                        
                        echo "âœ… Successfully pushed to GitHub!"
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            dir('content-generation') {
                sh '''
                echo "ğŸ§¹ Cleaning up..."
                rm -rf venv
                echo "ğŸ“ Final files:"
                ls -la
                '''
            }
            archiveArtifacts artifacts: 'content-generation/output.json', fingerprint: true
        }
        success {
            echo "ğŸ‰ Pipeline executed successfully!"
        }
        failure {
            echo "âŒ Pipeline failed - check logs above for details"
        }
    }
}
