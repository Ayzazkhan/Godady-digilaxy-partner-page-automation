pipeline {
    agent any

    environment {
        GEMINI_API_KEY = credentials('api-key')
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git',
                    credentialsId: 'github-credentials'
            }
        }

        stage('Setup Python Environment') {
            steps {
                dir('content-generation') {
                    sh '''
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install google-generativeai requests
                    '''
                }
            }
        }

        stage('Generate Content') {
            steps {
                dir('content-generation') {
                    sh '''
                    . venv/bin/activate
                    python3 content_generator.py || echo "‚ùå Script error ‚Äî continuing safely..."
                    '''
                }
            }
        }

        stage('Verify Content (Safe)') {
            steps {
                dir('content-generation') {
                    sh '''
                    echo "üîç SAFE VERIFICATION STARTED..."

                    python3 - << 'EOF'
import json, os

file = "generated_content.json"

# If file missing ‚Üí create fallback
if not os.path.exists(file):
    print("‚ùå File missing. Creating fallback JSON...")
    fallback = [{"id":1, "content":"fallback", "links_count":0}]
    json.dump(fallback, open(file,"w"), indent=2)
    exit(0)

raw = open(file,"r",encoding="utf-8").read().strip()

# If empty or bad
if raw == "" or raw.startswith("<") or raw.startswith("Error"):
    print("‚ùå Invalid JSON content. Creating fallback...")
    fallback = [{"id":1, "content":"fallback", "links_count":0}]
    json.dump(fallback, open(file,"w"), indent=2)
    exit(0)

try:
    data = json.loads(raw)
    print(f"‚úÖ JSON OK ‚Äî {len(data)} items, total links: {sum(i.get('links_count',0) for i in data)}")
except Exception as e:
    print("‚ùå JSON parse failed:", e)
    print("‚ö† Writing fallback JSON...")
    fallback = [{"id":1, "content":"fallback", "links_count":0}]
    json.dump(fallback, open(file,"w"), indent=2)
EOF
                    '''
                }
            }
        }

        stage('Push to GitHub') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'github-credentials',
                    usernameVariable: 'GIT_USERNAME',
                    passwordVariable: 'GIT_PASSWORD'
                )]) {
                    dir('content-generation') {
                        sh '''
                        echo "üöÄ Preparing to push changes..."

                        git config --global user.email "ayzazkhan82@gmail.com"
                        git config --global user.name "Ayzazkhan"

                        git status
                        git pull origin main --rebase

                        git add generated_content.json
                        git diff-index --quiet HEAD || git commit -m "Auto-generated content (Jenkins Build ${BUILD_NUMBER})"

                        git remote set-url origin https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git
                        git push origin main
                        echo "‚úÖ Successfully pushed to GitHub!"
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            sh 'rm -rf content-generation/venv'
            archiveArtifacts artifacts: 'content-generation/generated_content.json', fingerprint: true
        }
    }
}
