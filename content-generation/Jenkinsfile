pipeline {
    agent any
    
    environment {
        GEMINI_API_KEY = credentials('GEMINI_API_KEY')
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                    url: 'https://github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git',
                    credentialsId: 'github-credentials'
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                dir('content-generation') {
                    sh '''
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install google-generativeai requests
                    '''
                }
            }
        }
        
        stage('Generate Content') {
            steps {
                dir('content-generation') {
                    sh '''
                    . venv/bin/activate
                    python3 content_generator.py
                    '''
                }
            }
        }
        
        stage('Verify Generated File') {
            steps {
                dir('content-generation') {
                    sh '''
                    echo "ğŸ” VERIFYING GENERATED CONTENT:"
                    echo "ğŸ“ Current directory: $(pwd)"
                    echo "ğŸ“ Files in directory:"
                    ls -la
                    echo "ğŸ“„ Generated file size:"
                    ls -la generated_content.json
                    echo "ğŸ“Š File content preview:"
                    head -c 1000 generated_content.json || echo "âŒ Cannot read file"
                    echo "ğŸ“ˆ JSON validation:"
                    python3 -c "import json
try:
    with open('generated_content.json', 'r') as f:
        data = json.load(f)
    print(f'âœ… JSON Valid: {len(data)} items')
    for i, item in enumerate(data[:2]):
        print(f'  Item {i+1}: {item.get(\\\"keyword\\\", \\\"No keyword\\\")} - Links: {item.get(\\\"links_count\\\", 0)}')
except Exception as e:
    print(f'âŒ JSON Error: {e}')"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            sh 'rm -rf content-generation/venv'
            archiveArtifacts artifacts: 'content-generation/generated_content.json', fingerprint: true, allowEmptyArchive: true
        }
    }
}
