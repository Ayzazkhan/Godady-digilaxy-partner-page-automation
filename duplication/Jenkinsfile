pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        git credentialsId: 'github-access', url: 'https://github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git', branch: 'main'
      }
    }

    stage('Remove Duplicates') {
      steps {
        script {
          // Get domains dynamically from duplication/url.json
          def domainsOutput = sh(script: "python3 - <<'PY'\nimport json\nprint('\\n'.join(list(json.load(open('duplication/url.json')).keys())))\nPY", returnStdout: true).trim()
          def domains = domainsOutput.tokenize('\n')
          echo "Domains to process: ${domains}"

          for (d in domains) {
            def credId = "ftp-${d}"
            echo "Processing ${d} with credential id ${credId}"

            withCredentials([usernamePassword(credentialsId: credId, usernameVariable: 'FTP_USER', passwordVariable: 'FTP_PASS')]) {
              sh """
                export CURRENT_DOMAIN=${d}
                export FTP_USER=${FTP_USER}
                export FTP_PASS='${FTP_PASS}'
                python3 duplication/cleanup_duplicates.py
              """
            }
          }
        }
      }
    }
  }

  post {
    success { echo "✅ All duplicate blocks cleaned successfully" }
    failure { echo "❌ Duplication cleanup failed — check logs" }
  }
}
