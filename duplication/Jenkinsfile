pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        git credentialsId: 'github-access', url: 'https://github.com/Ayzazkhan/Godady-digilaxy-partner-page-automation.git', branch: 'main'
      }
    }

    stage('Remove Duplicates') {
      steps {
        script {
          // Get domains dynamically from duplication/url.json
          def domainsOutput = sh(script: "python3 - <<'PY'\nimport json\nprint('\\n'.join(list(json.load(open('duplication/urls.json')).keys())))\nPY", returnStdout: true).trim()
          def domains = domainsOutput.tokenize('\n')
          echo "Domains to process: ${domains}"

          // SINGLE CREDENTIAL USE - ek hi baar script run karo
          withCredentials([usernamePassword(credentialsId: 'ftp-londonlawyers.eu', usernameVariable: 'FTP_USER', passwordVariable: 'FTP_PASS')]) {
            sh """
              python3 duplication/cleanup_duplicates.py
            """
          }
        }
      }
    }
  }

  post {
    success { echo "✅ All duplicate blocks cleaned successfully" }
    failure { echo "❌ Duplication cleanup failed — check logs" }
  }
}
